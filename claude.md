# ScreenControlAgent 架构设计

基于 ScreenAgent (IJCAI 2024) 的改进版本，融合现代 VLM 技术和多模态感知能力。

---

## 原版 ScreenAgent 的局限性

| 问题 | 说明 |
|------|------|
| 模型能力受限 | 当时的 VLM（GPT-4V、CogAgent）在 GUI 理解和坐标定位上精度不足 |
| 单一 VNC 依赖 | VNC 延迟高、画质有损，不适合精细操作 |
| 缺乏结构化理解 | 纯视觉方式，无法获取 UI 元素的语义信息 |
| 反思机制简单 | 反思阶段缺乏记忆和长期规划能力 |
| 错误恢复弱 | 一旦操作失误，难以自我纠正 |

---

## 整体架构

```
┌────────────────────────────────────────────────────────────────┐
│                        用户任务输入                              │
└─────────────────────────────┬──────────────────────────────────┘
                              ↓
┌────────────────────────────────────────────────────────────────┐
│                     大脑层 (Brain Layer)                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │
│  │ 任务规划器   │  │ 记忆系统     │  │ 反思与自我纠错模块       │ │
│  │ (Planner)   │  │ (Memory)    │  │ (Reflection & Recovery) │ │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘ │
└─────────────────────────────┬──────────────────────────────────┘
                              ↓
┌────────────────────────────────────────────────────────────────┐
│                     感知层 (Perception Layer)                   │
│  ┌──────────────────┐  ┌──────────────────────────────────────┐│
│  │ 视觉感知 (VLM)    │  │ 结构化感知 (Accessibility Tree/DOM) ││
│  │ - 截图理解        │  │ - UI 元素树                         ││
│  │ - OCR            │  │ - 元素属性、层级关系                  ││
│  └──────────────────┘  └──────────────────────────────────────┘│
│                              ↓                                  │
│              多模态融合 (Grounding Module)                       │
└─────────────────────────────┬──────────────────────────────────┘
                              ↓
┌────────────────────────────────────────────────────────────────┐
│                     执行层 (Action Layer)                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │
│  │ 本地控制     │  │ 远程控制    │  │ API/自动化接口          │ │
│  │ (pyautogui) │  │ (VNC/RDP)   │  │ (Browser CDP, AT-SPI)  │ │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘ │
└────────────────────────────────────────────────────────────────┘
```

---

## 各层详细设计

### 1. 大脑层 (Brain Layer)

#### 任务规划器 (Planner)
- 将复杂任务分解为子任务序列
- 支持动态调整计划（当环境变化时）
- 可采用 ReAct / Tree-of-Thought 等推理范式

#### 记忆系统 (Memory)
- **短期记忆**：当前任务的操作历史、最近几帧截图
- **长期记忆**：成功的操作模式、常用应用的布局知识
- **情景记忆**：之前类似任务的经验（可用向量数据库存储）

#### 反思与自我纠错 (Reflection & Recovery)
- 每步操作后验证预期结果是否达成
- 检测异常状态（弹窗、错误提示、卡住）
- 自动回退或尝试替代方案

---

### 2. 感知层 (Perception Layer)

这是**最关键的升级点**——从纯视觉走向**视觉 + 结构化信息融合**。

| 感知方式 | 数据来源 | 优势 |
|----------|----------|------|
| 视觉感知 | 屏幕截图 + VLM | 通用性强，能理解任意界面 |
| 结构化感知 | Accessibility Tree (Windows UIAutomation / macOS AX / Linux AT-SPI) 或 Browser DOM | 精确的元素坐标、文本、状态 |

#### Grounding Module（多模态融合）
- 将 VLM 识别的"点击搜索框"映射到具体坐标
- 结合结构化信息验证/校正 VLM 的定位结果
- 类似于 Claude Computer Use 或 UI-TARS 的做法

---

### 3. 执行层 (Action Layer)

#### 多通道执行策略

| 场景 | 推荐方式 | 理由 |
|------|----------|------|
| 本地桌面 | pyautogui / pynput | 低延迟、高精度 |
| 远程机器 | VNC / RDP | 跨网络控制 |
| 浏览器任务 | CDP (Chrome DevTools Protocol) | 可直接操作 DOM，更稳定 |
| 特定应用 | 原生 API（如 Office COM） | 避免 UI 操作的不确定性 |

**原则：优先使用高层 API，视觉操作作为兜底**

---

## 关键改进点总结

| 维度 | 原版 ScreenAgent | 新版设计 |
|------|------------------|----------|
| 感知 | 纯视觉 | 视觉 + Accessibility Tree 融合 |
| 模型 | GPT-4V / CogAgent | Claude Computer Use / Qwen2.5-VL / UI-TARS |
| 记忆 | 无 | 短期 + 长期 + 情景记忆 |
| 规划 | 单步规划 | 层次化任务分解 + 动态调整 |
| 执行 | 仅 VNC | 多通道（本地/远程/API） |
| 容错 | 弱 | 主动验证 + 自动恢复 |

---

## 技术选型建议

| 组件 | 推荐选择 |
|------|----------|
| 核心 VLM | Claude (Computer Use) / Qwen2.5-VL / GPT-4o |
| Grounding | OmniParser / UI-TARS / SeeClick |
| 结构化感知 | Windows: UIAutomation; macOS: pyobjc; Linux: AT-SPI; Web: Playwright |
| 记忆存储 | 向量数据库（Chroma / Qdrant） |
| 编排框架 | LangGraph / 自研状态机 |

---

## MVP 版本范围建议

### Phase 1: 最小可用版本
- [ ] 基础截图捕获 + VLM 调用
- [ ] 简单的鼠标/键盘控制（pyautogui）
- [ ] 单步 规划-执行-验证 循环
- [ ] 支持单一平台（Windows）

### Phase 2: 增强感知
- [ ] 集成 Accessibility Tree
- [ ] Grounding Module 融合视觉与结构化信息
- [ ] 基础 OCR 能力

### Phase 3: 智能化
- [ ] 记忆系统（短期 + 长期）
- [ ] 多步任务规划
- [ ] 错误恢复机制

### Phase 4: 扩展
- [ ] 多平台支持
- [ ] 浏览器专用通道（CDP）
- [ ] API 自动化接口
